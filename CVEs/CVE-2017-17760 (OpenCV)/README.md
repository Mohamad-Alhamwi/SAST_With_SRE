# CVE-2017-17760 (OpenCV)

## Root Cause Analysis

A stack-based buffer overflow vulnerability existed in the file `imgcodecs/src/grfmt_pxm.cpp`. This type of vulnerability occurs when a program writes more data to a buffer located on the stack than what is actually allocated for that buffer.

The function where this vulnerability existed is as follows:

```C
bool PxMDecoder::readData( Mat& img )
{     
    /**
    * Reduced for space reasons.
    **/
    
	    memcpy( data, src, CV_ELEM_SIZE1(m_type)*m_width);

    /**
    * Reduced for space reasons.
    **/
}
```

The issue arose because an incorrect size value was used inside `memcpy()`. As a result, the `data` buffer was being assigned a value more than it could hold.

It was fixed as follows:

```C
memcpy(data, src, img.elemSize1()*m_width);
```

## Installing The Vulnerable Version

1.  We clone the repository:

```C
git clone https://github.com/opencv/opencv.git OpenCV
```

2.  We navigate into the project directory:

```C
cd OpenCV/
```

3.  We find the commit related to the vulnerability (using the first 7 characters of the commit ID provided above). I would like to view the 5 lines before and after the concerned commit for better context:

```C
git log --graph --oneline --all | grep -B 5 -A 5 "7bbe1a5"
```

> | \* | | | | | | | | 1eb2fa9efb Added universal intrinsics based implementations for CV_8UC2, CV_8UC3, CV_8UC4 bit-exact resizes.
>
> | | |/ / / / / / /
> 
> | |/| | | | | | |
>  
> \* | | | | | | | | 70d49446e9 Merge pull request #10369 from alalek:issue_10351
> 
> |\\ \\ \\ \\ \\ \\ \\ \\ \\
> 
> | \* | | | | | | | | \*\*7bbe1a53cf\*\* imgcodecs(pxm): fix memcpy size
> 
> \* | | | | | | | | | a2620f72c7 Merge pull request #10370 from pengli:dnn
> 
> |\\ \\ \\ \\ \\ \\ \\ \\ \\ \\
> 
> | |\*|\*|\*|\*|/ / / / /
> 
> |/| | | | | | | | |
> 
> | \* | | | | | | | | c5fc8e03ff cleanup unnecessary macros in convolution ocl kernel

Now, we should see the commit `7bbe1a53cf` for **CVE-2017-17760**.

4.  We `checkout` the commit before the patch to retrieve the vulnerable version. Note that we `checkout` the `a2620f72c7` commit, not the `70d49446e9` commit, because the git graph is read vertically from bottom to top:

```C
git checkout a2620f72c7
```

Eventually, we have the vulnerable version of **OpenCV** before the fix for **CVE-2017-17760** was applied. Now, we are ready to dive in.
