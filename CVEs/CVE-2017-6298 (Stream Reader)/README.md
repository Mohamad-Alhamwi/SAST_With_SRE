# CVE-2017-6298 (Yeraze's TNEF Stream Reader)

## Root Cause Analysis

A null pointer dereference vulnerability existed in the file `lib/ytnef.c`. This type of vulnerability occurs when trying to access an object reference that has a `null` value

This vulnerability existed in 24 different places in the aforementioned file. For this reason, only one place where the vulnerability existed is mentioned below.

```C
/**
* Reduced for space reasons.
**/
    
vl->data = calloc(vl->size, sizeof(BYTE));
temp_dword = SwapDWord((BYTE*)d, 4);
memcpy(vl->data, &temp_dword, vl->size);

/**
* Reduced for space reasons.
**/
```

At line 510, we can see that a memory block is being allocated using `calloc`. `Calloc` is supposed to return a pointer to the beginning of the newly allocated area, but on failure, it returns a `null` pointer. As a result, a potential null pointer dereference issue might arise at line 512 when it is used inside the `memcpy` function.

To fix this vulnerability a check for `null` should be added immediately after using memory allocatin functions such as `calloc`. The vulnerability in this file was fixed by defining a macro that checks for the validity of allocated memory pointers. Then, the macro was placed in the 24 places where `calloc` was used, right after allocation.
 
```C
/**
* Reduced for space reasons.
**/

#define ALLOCCHECK(x) { if(!x) { printf("Out of Memory\n"); exit(-1); } }

/**
* Reduced for space reasons.
**/

vl->data = calloc(vl->size, sizeof(BYTE));
ALLOCCHECK(vl->data);
temp_dword = SwapDWord((BYTE*)d, 4);
memcpy(vl->data, &temp_dword, vl->size);

/**
* Reduced for space reasons.
**/
```

## Installing The Vulnerable Version

1. We clone the repository:

```C
git clone https://github.com/Yeraze/ytnef.git StreamReader
```

2. We navigate into the project directory:

```C
cd StreamReader/
```

3. We find the commit related to the vulnerability (using the first 7 characters of the commit ID provided above). I would like to view the 5 lines before and after the concerned commit for better context:

```C
git log --graph --oneline --all | grep -B 5 -A 5 "f816ba5"
```

> |  * 12326ac fix another invalid write and huge allocation
> 
> |  * e2d39bd prevent 32 bit system int overflow
> 
> |  * dac0320 prevent out of bound reads
> 
> |  * cc6a49e increase version field, otherwise TNEFVersion might generate a buffer overflow and use snprintf to avoid this in the future
> 
> |  * 4f4598d avoid infinite loop for malicious input files
> 
> |  * **f816ba5** Do a quickfix to check for bad allocations
> 
> |/
> 
> \*   86df793 Merge pull request #25 from Yeraze/release/1.9
> 
> |\
> 
> |  * 57e9683 Prepare for 1.9 Release.
> 
> |/ 

Now, we should see the commit `f816ba5` for **CVE-2017-6298**.

4. We `checkout` the commit before the patch to retrieve the vulnerable version. Note that we `checkout` the `86df793` commit, not the `4f4598d` commit, because the git graph is read vertically from bottom to top:

```C
git checkout 86df793
```

Eventually, we have the vulnerable version of **Yeraze's TNEF Stream Reader** before the fix for **CVE-2017-6298** was applied. Now, we are ready to dive in.





