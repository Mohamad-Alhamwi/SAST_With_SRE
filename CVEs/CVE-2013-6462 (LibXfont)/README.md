# CVE-2013-6462 (LibXfont)

## Root Cause Analysis

A stack-based buffer overflow vulnerability existed in the file `src/bitmap/bdfread.c`. This type of vulnerability occurs when a program writes more data to a buffer located on the stack than what is actually allocated for that buffer.

The function where this vulnerability existed is as follows:

```C
static Bool bdfReadCharacters(FontFilePtr file, FontPtr pFont, bdfFileState *pState, int bit, int byte, int glyph, int scan)
{
	/**
	 * Reduced for space reasons.
	 **/
	
	char        charName[100];
	int         ignore;

	if (sscanf((char *) line, "STARTCHAR %s", charName) != 1)
	
	/**
	 * Reduced for space reasons.
	 **/
}
```

As we can see, at line 338 in `src/bitmap/bdfread.c`, a buffer of `char` type called `charName` is defined with a length of 100. And at line 341 , the `sscanf` function is used to read data into this buffer. However, the `%s` format specifier in `sscanf ` did not limit the number of characters to be read, allowing the function to read data of arbitrary length. This led to a buffer overflow vulnerability.

This vulnerability can be fixed by specifying the maximum number of characters to read in the format specifier. It was fixed by specifying the maximum number of characters  as follows:

```C
if (sscanf((char *) line, "STARTCHAR %99s", charName) != 1) {
```

## Installing The Vulnerable Version

1. We clone the repository:

```C
git clone https://gitlab.freedesktop.org/xorg/lib/libxfont.git LibXFont
```

2. We navigate into the project directory:

```C
cd LibXFont/
```

3. We find the commit related to the vulnerability (using the first 7 characters of the commit ID provided above). I would like to view the 5 lines before and after the concerned commit for better context:

```C
git log --graph --oneline --all | grep -B 5 -A 5 "4d024ac"
```

> * 63c7ac4 Initialize (unused) data field in fsListCataloguesReq before sending it.
> * d279ffa Remove redundant declaration of FontFileStartListFonts()
> * 2fb6295 Fix unused variable 'dir' warnings
> * 3011006 libXfont 1.4.7
> * 2a84680 Limit additional sscanf strings to fit buffer sizes
> * **4d024ac** CVE-2013-6462: unlimited sscanf overflows stack buffer in bdfReadCharacters()
> * fdcf9a9 Add AC_USE_SYSTEM_EXTENSIONS to expose non-standard extensions
> * 0d24378 Don't leak old allocation if realloc fails to enlarge it
> * 5e27c36 Make serverGeneration unsigned
> * 7d34534 Replace malloc(strlen)+strcpy/strcat calls with strdup
> * 8a9fc31 xstrdup -> strdup

Now, we should see the commit `4d024ac` for **CVE-2013-6462**.

4. We `checkout` the commit before the patch to retrieve the vulnerable version. Note that we `checkout` the `fdcf9a9` commit, not the `2a84680` commit, because the git graph is read vertically from bottom to top:

```C
git checkout fdcf9a9
```

Eventually, we have the vulnerable version of **LibXfont** before the fix for **CVE-2013-6462** was applied. Now, we are ready to dive in.
