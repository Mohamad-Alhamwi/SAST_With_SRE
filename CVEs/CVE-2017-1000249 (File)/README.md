# CVE-2017-1000249 (The file utility)

## Root Cause Analysis

A stack-based buffer overflow vulnerability existed in the file `src/readelf.c`. This type of vulnerability occurs when a program writes more data to a buffer located on the stack than what is actually allocated for that buffer.

The function where this vulnerability existed is as follows:

```C
private int /*ARGSUSED*/ do_bid_note(struct magic_set *ms, unsigned char *nbuf, uint32_t type, int swap __attribute__((__unused__)), uint32_t namesz, uint32_t descsz, size_t noff, size_t doff, int *flags)
{
    if (namesz == 4 && strcmp((char *)&nbuf[noff], "GNU") == 0 &&
        type == NT_GNU_BUILD_ID && (descsz >= 4 || descsz <= 20)) {

    uint8_t desc[20];

    /**
     * Reduced for space reasons.
     **/

    (void)memcpy(desc, &nbuf[doff], descsz);

    /**
    * Reduced for space reasons.
    **/
}
```

As we can see, at line 512 in `src/readelf.c`, the `(descsz >= 4 || descsz <= 20)` expression inside the `if` condition **always evaluates** to `true`, regardless of the value of `descsz`, because at least one condition will always be `true`. This led to a buffer overflow vulnerability because it allows an attacker to overwrite the fixed 20-bytes stack buffer, `desc`, defined at line 513, with a specially crafted value in the call to `memcpy` at line 533.

This vulnerability can be fixed by changing the boolean operator `||` to `&&`. It was fixed as follows:

```C
type == NT_GNU_BUILD_ID && (descsz >= 4 && descsz <= 20)) {
```

## Installing The Vulnerable Version

1.  We clone the repository:

```C
git clone https://github.com/file/file.git File
```

2.  We navigate into the project directory:

```C
cd File
```

3.  Since we know the commit that introduced the **CVE-2017-1000249** vulnerability, we can directly `checkout` into the state of the repository at that commit.

```C
git checkout 9611f31313a93aa036389c5f3b15eea53510d4d1
```

Eventually, we have the vulnerable version of **File** before the fix for **CVE-2017-1000249** was applied. Now, we are ready to dive in.
